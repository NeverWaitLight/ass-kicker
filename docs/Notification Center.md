---
date created: 2022-09-22 16:57
date updated: 2025-06-13 13:52
---

# Notification Center

ç»Ÿä¸€é€šçŸ¥ä¸­å¿ƒå¹³å°ï¼Œæ—¨åœ¨é›†æˆå’Œç®¡ç†å¤šç§é€šçŸ¥æ¸ é“ç±»å‹ [SMS](#SMS) / [Email](#Email) / [IM](#IM) / [Push](#Push) çš„å¤šä¸ªä¾›åº”å•†å®ç°ã€‚ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- æ”¯æŒåŒä¸€æ¸ é“ç±»å‹çš„å¤šä¸ªä¾›åº”å•†æ¥å…¥ï¼ˆå¦‚åŒæ—¶é›†æˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰çŸ­ä¿¡æä¾›å•†ï¼‰
- æ™ºèƒ½è·¯ç”±é€‰æ‹©æœ€ä¼˜ä¾›åº”å•†å‘é€
- ç»Ÿä¸€çš„æ¶ˆæ¯æ¨¡æ¿ã€ä¼˜å…ˆçº§å’ŒçŠ¶æ€ç®¡ç†
- è·¨æ¸ é“çš„æ¶ˆæ¯æ’¤å›å’Œå›æ‰§åŠŸèƒ½
- ä¾›åº”å•†çº§çš„é™æµå’Œæ•…éšœè½¬ç§»æœºåˆ¶

é€šè¿‡æ ‡å‡†åŒ–æ¥å£ç®€åŒ–ä¸šåŠ¡ç³»ç»Ÿä¸å„ç±»é€šçŸ¥æœåŠ¡çš„é›†æˆï¼Œæé«˜æ¶ˆæ¯é€è¾¾ç‡å’Œç³»ç»Ÿå¯é æ€§ã€‚

## æ•´ä½“æ¶æ„

![480](attachments/022343287708f8cb3f800dd902e39abe.png)

- **Message Controller**: æ¥æ”¶å‘é€ä»»åŠ¡ï¼Œç®¡ç†è°ƒåº¦ Message Worker
  - **Client Authorization**: éªŒè¯å‘é€æ–¹èº«ä»½ï¼Œé¿å…è¢«æ”»å‡»
  - **Rate Limiter**: é¢‘ç‡é™åˆ¶ï¼Œé¿å…è´¹ç”¨å¼‚å¸¸æ¶ˆè€—
  - **Connection Pool**: ç”¨æˆ·è®¾å¤‡ã€é€šé“è¿æ¥æ± ï¼Œé¿å…é‡å¤é€šçŸ¥
  - **User Pool**: ç”¨æˆ·æ± ï¼Œåˆ†ç»„å¹¿æ’­
- **Message Worker**: æ‰§è¡Œå‘é€ä»»åŠ¡ï¼Œä¿å­˜æ¶ˆæ¯æ—¥å¿—
  - **Template**: æ¶ˆæ¯æ¨¡æ¿ï¼Œç›¸åŒä¸šåŠ¡å«ä¹‰ä¸åŒè¯­è¨€çš„æ¨¡æ¿ï¼Œä½¿ç”¨ç›¸åŒçš„æ¨¡æ¿ code å’Œå¯¹åº”è¯­è¨€çš„è¯­è¨€ code
  - **Channel**ï¼š åŒä¸€ä¸ªæä¾›å•†ä¸‹çš„ä¸åŒè´¦å·åˆå§‹åŒ–çš„å‘é€è¿æ¥å°±æ˜¯ä¸åŒçš„ channel
  - **Message**: éœ€è¦å‘é€çš„æ¶ˆæ¯ï¼ŒåŒ…å«å‘é€æ–¹ã€æ¥æ”¶æ–¹ä¿¡æ¯ï¼Œæ¶ˆæ¯å†…å®¹ï¼ˆå¦‚æœä½¿ç”¨æ¨¡æ¿å°±æ˜¯æ¨¡æ¿ id å’Œå‚æ•°åˆ—è¡¨ï¼‰
  - **Channel Scheduler**: è°ƒåº¦ channel å®ç°è·¯ç”±ã€ç†”æ–­ç­‰åŠŸèƒ½

```mermaid
flowchart TD
    A[HTTPæ¥å£è°ƒç”¨] --> B[receiver]

    B --> C[Kafkaé›†ç¾¤]
    C --> D{æ¶ˆæ¯ç±»å‹ä¸ä¼˜å…ˆçº§è·¯ç”±}

    D -->|SMS| E[sms-topic<br/>åŒ…å«é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡ç”Ÿäº§ 32KB]
    D -->|Email| F[email-topic<br/>åŒ…å«é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡ç”Ÿäº§ 32KB]
    D -->|IM| G[im-topic<br/>åŒ…å«é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡ç”Ÿäº§ 32KB]
    D -->|Push| H[push-topic<br/>åŒ…å«é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡ç”Ÿäº§ 32KB]

    E --> I[SMS KafkaListener<br/>å¤„ç†é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡æ‹‰å–100æ¡]
    F --> J[Email KafkaListener<br/>å¤„ç†é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡æ‹‰å–100æ¡]
    G --> K[IM KafkaListener<br/>å¤„ç†é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡æ‹‰å–100æ¡]
    H --> L[Push KafkaListener<br/>å¤„ç†é«˜/æ™®é€š/ä½ä¼˜å…ˆçº§<br/>æ‰¹é‡æ‹‰å–100æ¡]

    I --> M[ğŸš€å¼‚æ­¥å†™å…¥MySQLä»»åŠ¡è¡¨<br/>æœ¬åœ°é˜Ÿåˆ—+æ‰¹é‡åˆ·ç›˜]
    J --> M
    K --> M
    L --> M

    M --> N{é€‰æ‹©SenderExecutor}
    N -->|SMSæ¶ˆæ¯| O[SMS SenderExecutor<br/>çº¿ç¨‹æ± æœ€å¤§500çº¿ç¨‹]
    N -->|Emailæ¶ˆæ¯| P[Email SenderExecutor<br/>çº¿ç¨‹æ± æœ€å¤§500çº¿ç¨‹]
    N -->|IMæ¶ˆæ¯| Q[IM SenderExecutor<br/>çº¿ç¨‹æ± æœ€å¤§500çº¿ç¨‹]
    N -->|Pushæ¶ˆæ¯| R[Push SenderExecutor<br/>çº¿ç¨‹æ± æœ€å¤§500çº¿ç¨‹]

    O --> S[ğŸ”æä¾›å•†æ™ºèƒ½è°ƒåº¦]
    P --> S
    Q --> S
    R --> S

    S --> T[ğŸ“‹è§„åˆ™åŒ¹é…å¼•æ“<br/>åœ°å€è§„åˆ™ã€è¯­è¨€è§„åˆ™ã€æ—¶é—´è§„åˆ™]
    T --> U{è§„åˆ™åŒ¹é…ç»“æœ}
    U -->|åœ°å€åŒ¹é…| V[æŒ‡å®šåœ°åŒºæä¾›å•†<br/>å¦‚ï¼šå›½å†…é˜¿é‡Œäº‘/æµ·å¤–AWS]
    U -->|è¯­è¨€åŒ¹é…| W[æŒ‡å®šè¯­è¨€æä¾›å•†<br/>å¦‚ï¼šä¸­æ–‡è…¾è®¯äº‘/è‹±æ–‡Twilio]
    U -->|æ—¶é—´åŒ¹é…| X[æŒ‡å®šæ—¶æ®µæä¾›å•†<br/>å¦‚ï¼šå·¥ä½œæ—¶é—´ä¸»æä¾›å•†]
    U -->|æ— åŒ¹é…è§„åˆ™| Y[é»˜è®¤æä¾›å•†åˆ—è¡¨]

    V --> Z{æä¾›å•†å¥åº·æ£€æŸ¥}
    W --> Z
    X --> Z
    Y --> Z

    Z -->|å¥åº·| AA[é€‰ä¸­æä¾›å•†]
    Z -->|æ•…éšœ| BB[ğŸ”„ç†”æ–­åˆ‡æ¢å¤‡ç”¨æä¾›å•†]
    Z -->|å…¨éƒ¨æ•…éšœ| CC[å¿«é€Ÿå¤±è´¥<br/>æ ‡è®°å‘é€å¤±è´¥]

    AA --> DD[ğŸ“¡è°ƒç”¨æä¾›å•†API]
    BB --> DD

    DD --> EE{å‘é€ç»“æœ}
    EE -->|æˆåŠŸ| FF[ğŸš€å¼‚æ­¥å†™å…¥MySQLç»“æœè¡¨]
    EE -->|å¤±è´¥| GG[é‡è¯•ç­–ç•¥åˆ¤æ–­]

    FF --> HH[âœ…å‘Kafkaç¡®è®¤æ¶ˆè´¹]
    CC --> II[ğŸš€å¼‚æ­¥å†™å…¥MySQLå¤±è´¥ç»“æœ]
    II --> JJ[âœ…å‘Kafkaç¡®è®¤æ¶ˆè´¹]

    GG --> KK{é‡è¯•æ¬¡æ•°æ£€æŸ¥}
    KK -->|â‰¥ 3æ¬¡| LL[ğŸ’¾æ ‡è®°æœ€ç»ˆå¤±è´¥]
    KK -->|< 3æ¬¡| MM[ğŸ”„é‡æ–°æ”¾å…¥Kafkaé˜Ÿåˆ—<br/>æŒ‡æ•°é€€é¿å»¶è¿Ÿ]

    HH --> NN[âœ…ä»»åŠ¡å®Œæˆ]
    JJ --> OO[âŒä»»åŠ¡ç»ˆæ­¢]
    LL --> OO
    MM --> C

    style B fill:#e1f5fe
    style C fill:#e3f2fd
    style M fill:#fff3e0
    style S fill:#e8f5e8
    style T fill:#e3f2fd
    style U fill:#f3e5f5
    style DD fill:#f3e5f5
    style FF fill:#fff3e0
    style O fill:#e8f5e8
    style P fill:#e8f5e8
    style Q fill:#e8f5e8
    style R fill:#e8f5e8
    style BB fill:#ffebee
    style CC fill:#ffcdd2
    style II fill:#ffcdd2
```

## Message Controller

Message Gateway è´Ÿè´£æ¥æ”¶å‘é€æ¶ˆæ¯è¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

- æƒé™éªŒè¯ï¼šåˆ¤æ–­å‘é€æ–¹æ˜¯å¦å…·æœ‰ä½¿ç”¨æŒ‡å®šæ¨¡æ¿æˆ–æŒ‡å®š channel çš„æƒé™
- é¢‘ç‡é™åˆ¶ï¼šåŸºäºå‘é€æ–¹ã€æ¥æ”¶æ–¹ã€æ¶ˆæ¯ç±»å‹ç­‰å¤šç»´åº¦é™æµ
- ä¼˜å…ˆçº§å¤„ç†ï¼šæ ¹æ®æ¶ˆæ¯ä¼˜å…ˆçº§è°ƒæ•´å¤„ç†é¡ºåº
- æ¶ˆæ¯é¢„å¤„ç†ï¼šéªŒè¯æ¶ˆæ¯æ ¼å¼ã€å‚æ•°å®Œæ•´æ€§ç­‰

```mermaid
flowchart TD
    A[æ¶ˆæ¯å‘é€è¯·æ±‚] --> B[Message Gateway]

    B --> C{æƒé™éªŒè¯}
    C -->|æƒé™ä¸è¶³| D[è¿”å›æƒé™é”™è¯¯]
    C -->|æƒé™é€šè¿‡| E{é¢‘ç‡é™åˆ¶æ£€æŸ¥}

    E -->|è§¦å‘é™æµ| F[è¿”å›é™æµé”™è¯¯]
    E -->|é¢‘ç‡æ­£å¸¸| G[æ¶ˆæ¯é¢„å¤„ç†]

    G --> H{æ ¼å¼éªŒè¯}
    H -->|æ ¼å¼é”™è¯¯| I[è¿”å›æ ¼å¼é”™è¯¯]
    H -->|æ ¼å¼æ­£ç¡®| J{ä¼˜å…ˆçº§å¤„ç†}

    J --> K[Emergency<br/>ç´§æ€¥æ¶ˆæ¯]
    J --> L[High<br/>é«˜ä¼˜å…ˆçº§]
    J --> M[Normal<br/>æ™®é€šä¼˜å…ˆçº§]
    J --> N[Low<br/>ä½ä¼˜å…ˆçº§]
    J --> O[Background<br/>åå°æ¶ˆæ¯]

    K --> P[æ’å…¥é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—]
    L --> P
    M --> Q[æ’å…¥æ™®é€šä¼˜å…ˆçº§é˜Ÿåˆ—]
    N --> R[æ’å…¥ä½ä¼˜å…ˆçº§é˜Ÿåˆ—]
    O --> R

    P --> S[å‘é€åˆ° Kafka Topic]
    Q --> S
    R --> S

    S --> T[è¿”å›æ¶ˆæ¯ID]

    %% æ ·å¼è®¾ç½®
    style C fill:#e3f2fd
    style E fill:#fff3e0
    style G fill:#e8f5e8
    style H fill:#e3f2fd
    style J fill:#f3e5f5
    style K fill:#ffcdd2
    style L fill:#ffe0b2
    style M fill:#e8f5e8
    style N fill:#e1f5fe
    style O fill:#f1f8e9
    style D fill:#ffcdd2
    style F fill:#ffcdd2
    style I fill:#ffcdd2
```

### ä¼˜å…ˆçº§

æ¶ˆæ¯ä¼˜å…ˆçº§åˆ†ä¸º 5 ä¸ªç­‰çº§ï¼Œä»é«˜åˆ°ä½ä¾æ¬¡ä¸ºï¼š

| ä¼˜å…ˆçº§ | åç§°         | æè¿°                            |
| --- | ---------- | ----------------------------- |
| 0   | Emergency  | æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¦‚ç³»ç»Ÿæ•…éšœã€å®‰å…¨è­¦æŠ¥ç­‰ï¼Œä¼šè§¦å‘æ‰€æœ‰å¯ç”¨é€šçŸ¥æ¸ é“ |
| 1   | High       | é‡è¦é€šçŸ¥ï¼Œå¦‚è´¦æˆ·å®‰å…¨å˜æ›´ã€æ”¯ä»˜ç¡®è®¤ç­‰            |
| 2   | Normal     | å¸¸è§„é€šçŸ¥ï¼Œé»˜è®¤ä¼˜å…ˆçº§                    |
| 3   | Low        | ä½ä¼˜å…ˆçº§é€šçŸ¥ï¼Œå¦‚è¥é”€ä¿¡æ¯ã€ç³»ç»Ÿå…¬å‘Šç­‰            |
| 4   | Background | æœ€ä½ä¼˜å…ˆçº§ï¼Œä»…åœ¨ç”¨æˆ·ä¸»åŠ¨æŸ¥çœ‹æ—¶æ˜¾ç¤ºï¼Œä¸ä¼šä¸»åŠ¨æ¨é€      |

ä¼˜å…ˆçº§ä¼šå½±å“ï¼š

- æ¶ˆæ¯å‘é€çš„æ¸ é“é€‰æ‹©
- é‡è¯•ç­–ç•¥
- é€šçŸ¥çš„å±•ç¤ºæ–¹å¼(å¦‚ç´§æ€¥é€šçŸ¥ä¼šæŒç»­æé†’ç›´åˆ°ç¡®è®¤)

### é€šçŸ¥èŒƒå›´

#### å•æ’­

![360](attachments/a6924c657cd21a6d57be7d2495c7ce0d.png)

#### å¤šæ’­

![360](attachments/660ebf589e591b006de6ae64d289b15f.png)

#### å¹¿æ’­

![360](attachments/ed2281719872c4e931cd7c289bed86a7.png)

#### å¹¿æ’­åˆ†å±‚å¤„ç†æ¶æ„

å¹¿æ’­æ¶ˆæ¯ç”±äºæ¶‰åŠå¤§é‡åœ°å€ï¼Œéœ€è¦é‡‡ç”¨åˆ†å±‚å¤„ç†ç­–ç•¥æ¥ä¼˜åŒ–æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ã€‚ç³»ç»Ÿæ ¹æ®æ¶ˆæ¯è§„æ¨¡ã€Channel èƒ½åŠ›å’Œä¸šåŠ¡ä¼˜å…ˆçº§è¿›è¡Œæ™ºèƒ½åˆ†å±‚å¤„ç†ã€‚

**åˆ†å±‚ç­–ç•¥è¯´æ˜ï¼š**

1. **å°æ‰¹é‡å¹¿æ’­ï¼ˆâ‰¤100 åœ°å€ï¼‰**ï¼šç›´æ¥å¤„ç†ï¼Œä½¿ç”¨æ™®é€šå¤„ç†é˜Ÿåˆ—
2. **ä¸­æ‰¹é‡å¹¿æ’­ï¼ˆ100-10000 åœ°å€ï¼‰**ï¼šæŒ‰ Channel èƒ½åŠ›åˆ†æ‰¹å¤„ç†
3. **å¤§æ‰¹é‡å¹¿æ’­ï¼ˆ>10000 åœ°å€ï¼‰**ï¼šå¼‚æ­¥æµå¼å¤„ç†ï¼Œä¸“ç”¨èµ„æºæ± 

**æ ¸å¿ƒä¼˜åŒ–åŸåˆ™ï¼š**

- é¿å…æ¶ˆæ¯çˆ†ç‚¸ï¼šä¸å°†å¹¿æ’­æ‹†åˆ†æˆå¤§é‡å•æ’­
- Channel é€‚é…ï¼šæ ¹æ®æ‰¹é‡èƒ½åŠ›æ™ºèƒ½åˆ†ç»„
- èµ„æºéš”ç¦»ï¼šä¸åŒè§„æ¨¡ä½¿ç”¨ç‹¬ç«‹å¤„ç†èµ„æº
- æ—¥å¿—ä¼˜åŒ–ï¼šé‡‡ç”¨èšåˆç»Ÿè®¡å‡å°‘å­˜å‚¨å‹åŠ›

```mermaid
flowchart TD
    A[å¹¿æ’­æ¶ˆæ¯è¯·æ±‚] --> B[Message Gateway]
    B --> C[æ¶ˆæ¯è§„æ¨¡åˆ¤æ–­]

    C -->|â‰¤100åœ°å€| D[å°æ‰¹é‡å¤„ç†]
    C -->|100-10000åœ°å€| E[ä¸­æ‰¹é‡å¤„ç†]
    C -->|>10000åœ°å€| F[å¤§æ‰¹é‡å¤„ç†]

    %% å°æ‰¹é‡å¤„ç†åˆ†æ”¯
    D --> G[ç›´æ¥å‘é€é˜Ÿåˆ—<br/>normal-topic]
    G --> H[æ™®é€šçº¿ç¨‹æ± <br/>32çº¿ç¨‹]

    %% ä¸­æ‰¹é‡å¤„ç†åˆ†æ”¯
    E --> I[Channelèƒ½åŠ›åˆ†æ]
    I --> J[æ™ºèƒ½åˆ†ç»„å™¨]
    J --> K[æ‰¹é‡Channelç»„<br/>æ”¯æŒæ‰¹é‡1000]
    J --> L[å•æ¡Channelç»„<br/>ä¸æ”¯æŒæ‰¹é‡]

    K --> M[æ‰¹é‡å¤„ç†é˜Ÿåˆ—<br/>batch-topic]
    L --> N[å¹¶å‘å¤„ç†é˜Ÿåˆ—<br/>concurrent-topic]

    M --> O[æ‰¹é‡ä¸“ç”¨çº¿ç¨‹æ± <br/>16çº¿ç¨‹]
    N --> P[å¹¶å‘ä¸“ç”¨çº¿ç¨‹æ± <br/>64çº¿ç¨‹]

    %% å¤§æ‰¹é‡å¤„ç†åˆ†æ”¯
    F --> Q[æµå¼å¤„ç†å™¨]
    Q --> R[åŠ¨æ€åˆ†ç‰‡<br/>æ¯ç‰‡5000åœ°å€]
    R --> S[å¼‚æ­¥å¤„ç†é˜Ÿåˆ—<br/>stream-topic]
    S --> T[æµå¼çº¿ç¨‹æ± <br/>8çº¿ç¨‹+å¤§å†…å­˜]

    %% Channelè°ƒç”¨
    H --> U[Channel APIè°ƒç”¨]
    O --> V[æ‰¹é‡APIè°ƒç”¨<br/>1æ¬¡è°ƒç”¨1000åœ°å€]
    P --> W[å¹¶å‘APIè°ƒç”¨<br/>å¤šçº¿ç¨‹å¹¶å‘]
    T --> X[æµå¼APIè°ƒç”¨<br/>åˆ†ç‰‡æ‰¹é‡å¤„ç†]

    %% æ—¥å¿—è®°å½•
    U --> Y[æ ‡å‡†æ—¥å¿—è®°å½•]
    V --> Z[èšåˆç»Ÿè®¡æ—¥å¿—<br/>æ‰¹æ¬¡æˆåŠŸç‡]
    W --> AA[å‹ç¼©å¤±è´¥æ—¥å¿—<br/>æˆåŠŸç»Ÿè®¡è®¡æ•°]
    X --> BB[åˆ†ç‰‡èšåˆæ—¥å¿—<br/>å®æ—¶ç»Ÿè®¡æ›´æ–°]

    %% ç»“æœæ±‡æ€»
    Y --> CC[å•ä¸€ç»“æœè¿”å›]
    Z --> DD[æ‰¹é‡ç»“æœèšåˆ]
    AA --> DD
    BB --> EE[æµå¼ç»“æœæ±‡æ€»]

    %% æ ·å¼è®¾ç½®
    style D fill:#e8f5e8
    style E fill:#fff3e0
    style F fill:#ffebee
    style G fill:#e3f2fd
    style M fill:#e3f2fd
    style N fill:#e3f2fd
    style S fill:#f3e5f5
    style V fill:#e8f5e8
    style W fill:#ffe0b2
    style X fill:#f1f8e9
    style Z fill:#e1f5fe
    style AA fill:#e1f5fe
    style BB fill:#e1f5fe
```

**åˆ†å±‚å¤„ç†è¯¦ç»†è¯´æ˜ï¼š**

**1. å°æ‰¹é‡å¹¿æ’­å¤„ç†ï¼ˆâ‰¤100 åœ°å€ï¼‰**

- ç›´æ¥ä½¿ç”¨æ™®é€šå¤„ç†é˜Ÿåˆ—ï¼Œæ— éœ€ç‰¹æ®Šä¼˜åŒ–
- é€‚ç”¨äºéƒ¨é—¨é€šçŸ¥ã€å°ç»„æ¶ˆæ¯ç­‰åœºæ™¯
- å¤„ç†å»¶è¿Ÿï¼š< 5 ç§’

**2. ä¸­æ‰¹é‡å¹¿æ’­å¤„ç†ï¼ˆ100-10000 åœ°å€ï¼‰**

- æ ¹æ® Channel èƒ½åŠ›è¿›è¡Œæ™ºèƒ½åˆ†ç»„
- æ”¯æŒæ‰¹é‡çš„ Channelï¼šæŒ‰æœ€å¤§æ‰¹é‡èƒ½åŠ›åˆ†æ‰¹ï¼ˆå¦‚ 1000 ä¸ª/æ‰¹ï¼‰
- ä¸æ”¯æŒæ‰¹é‡çš„ Channelï¼šä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘å¤„ç†
- é€‚ç”¨äºå…¨å‘˜é€šçŸ¥ã€è¥é”€æ¨å¹¿ç­‰åœºæ™¯
- å¤„ç†å»¶è¿Ÿï¼š< 30 ç§’

**3. å¤§æ‰¹é‡å¹¿æ’­å¤„ç†ï¼ˆ>10000 åœ°å€ï¼‰**

- é‡‡ç”¨æµå¼å¤„ç†ï¼ŒåŠ¨æ€åˆ†ç‰‡
- æ¯ç‰‡ 5000 åœ°å€ï¼Œé¿å…å†…å­˜å‹åŠ›
- å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡å…¶ä»–æ¶ˆæ¯
- é€‚ç”¨äºç³»ç»Ÿå…¬å‘Šã€é‡å¤§äº‹ä»¶é€šçŸ¥ç­‰åœºæ™¯
- å¤„ç†å»¶è¿Ÿï¼š< 2 åˆ†é’Ÿ

**æ—¥å¿—è®°å½•ä¼˜åŒ–ï¼š**

- å°æ‰¹é‡ï¼šæ ‡å‡†å•æ¡æ—¥å¿—è®°å½•
- ä¸­æ‰¹é‡ï¼šæŒ‰æ‰¹æ¬¡è®°å½•æˆåŠŸç‡ï¼Œä»…è¯¦è®°å¤±è´¥åœ°å€
- å¤§æ‰¹é‡ï¼šåˆ†ç‰‡èšåˆç»Ÿè®¡ï¼Œå®æ—¶æ›´æ–°è¿›åº¦

**èµ„æºéš”ç¦»ä¿è¯ï¼š**

- ä¸åŒè§„æ¨¡ä½¿ç”¨ç‹¬ç«‹çš„ Kafka Topic å’Œçº¿ç¨‹æ± 
- é˜²æ­¢å¤§æ‰¹é‡æ¶ˆæ¯å½±å“å°æ‰¹é‡æ¶ˆæ¯çš„å®æ—¶æ€§
- å„å±‚çº§å¯ç‹¬ç«‹æ‰©å®¹å’Œä¼˜åŒ–

#### ä»»æ’­

![360](attachments/5839dc2cb21e04f471bf0f0348a2a873.png)

## Message Worker

### Template

å‘é€æ¶ˆæ¯çš„æ¨¡æ¿ï¼Œæ–¹ä¾¿ç®¡ç†æ¶ˆæ¯å†…å®¹ï¼Œå‡å°‘å‘é€æ¶ˆæ¯è¯·æ±‚çš„æ•°æ®é‡

æ¶ˆæ¯ Message å’Œæ¨¡æ¿ Template çš„æ ¸å¿ƒå±æ€§å¦‚ä¸‹ï¼š

```mermaid
classDiagram
	Template <|-- LocalizedTemplate
	class Template{
	    +long id
	    +String name
	    +ChannelType channelType
	    +String code
	    +String recommend
	    +bool enable
	}

	class LocalizedTemplate{
	    +long id
	    +long templateId
	    +String language
	    +String content
		+bool enable
	}

	class FixedParams{
		+long id
		+String key
		+String value
		+String method
	}
```

æ¨¡ç‰ˆæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "name": "çŸ­ä¿¡éªŒè¯ç ",
  "code": "cpatch",
  "channelType": "SMS",
  "language": "en",
  "content": "Your Google {{business}} verification code is: {{code}}. Please do not share thie code with anyone.",
  "enable": true
}
```

æ¶ˆæ¯å¯ä»¥æ²¡æœ‰æ¨¡æ¿ï¼Œç”±å‘é€æ–¹ç›´æ¥å¡«å†™æ¶ˆæ¯å†…å®¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ¨¡æ¿ç»„è£…å®Œæ•´çš„æ¶ˆæ¯ã€‚
ä½¿ç”¨æ¨¡æ¿å‘é€çŸ­ä¿¡éªŒè¯ç å¦‚ä¸‹ï¼š

```json
{
  "channelType": "SMS",
  "template": "captch",
  "language": "en",
  "params": {
    "business": "registion",
    "code": "123987"
  },
  "address": {
    "phoneNumber": "+86 13398765432"
  }
}
```

æ³¨å†Œè´¦å·çš„çŸ­ä¿¡éªŒè¯ç æ¨¡æ¿å¦‚ä¸‹ï¼š

```json
{
  "owner": "account-center",
  "code": "registion",
  "language": "en",
  "content": "Your Google {{business}} verification code is: {{code}}. Please do not share thie code with anyone."
}
```

å®é™…å‘é€çš„æ¶ˆæ¯å¦‚ä¸‹ï¼š

```
Your Google registration verification code is: 123456. Please do not share thie code with anyone.
```

### Channel

```json
{
  "name": "Aliyun",
  "code": "Aliyun",
  "tyep": "SMS",
  "hots": "https://aliyun.sms",
  "send": "/send",
  "result-check": "/result-check"
}
```

é€šé“å®šä¹‰ï¼šä¸€ä¸ª Channel çš„ä¸€ä¸ªè´¦å·ï¼ˆAccountï¼‰æˆ–èº«ä»½ï¼ˆIdentityï¼‰å°±æ˜¯ä¸€ä¸ªé€šé“

åŠŸèƒ½éœ€æ±‚å¦‚ä¸‹ï¼š

```json
{
  "name": "Telegramé€šé“1",
  "code": "telegram1",
  "provider": {
    "name": "Telegram",
    "code": "Telegram",
    "type": "IM",
    "url": "https://telegram.im/send"
  },
  "check-path": "/check-result",
  "identity": {
    "token": "dsfadsf213123790878"
  },
  "rule": "NOT_EQUALS",
  "regrex": "^warning(\\w+)?$"
}
```

ç›®çš„åœ°ç»‘å®š

|  ç¼–å· | è§„åˆ™         | å¤„ç†çš„åœ°å€       |
| :-: | :--------- | ----------- |
|  1  | ANY        | ä»»æ„åœ°å€        |
|  2  | EQUALS     | æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼çš„åœ°å€  |
|  3  | NOT_EQUALS | ä¸æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼çš„åœ°å€ |

é€šé“ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç»‘å®šæ¶ˆæ¯åœ°å€ï¼Œå½“é€šé“ X é…ç½®äº†åœ°å€è¡¨è¾¾å¼ä¹‹åï¼Œæ‰€æœ‰æ»¡è¶³çš„åœ°å€å°†åªä½¿ç”¨ X é€šé“å‘é€ã€‚

### Channel Scheduler

- è½®è¯¢
- åŠ æƒè½®è¯¢

### Message

**ç«™å†…ä¿¡ï¼ˆOn-Site Messagesï¼‰** æ˜¯å¤§éƒ¨åˆ†æ¨é€æ¶ˆæ¯çš„æ¥æºï¼Œé€šè¿‡ [SMS](#SMS) / [Email](#Email) / [IM](#IM) ç­‰ç«™å¤–æ¸ é“å‘é€çš„æ¶ˆæ¯ï¼Œé€šå¸¸æƒ…å†µä¸‹æ— éœ€åœ¨ç«™å†…ä¿¡ä¸­å†æ¬¡å±•ç¤º

```mermaid
classDiagram
  class Message{
    +long id
	+String templateCode  // ä½¿ç”¨çš„æ¨¡æ¿
	+String params        // å¡«å……æ¨¡æ¿çš„å‚æ•°
    +String content       // ç›´æ¥å‘é€çš„å†…å®¹ï¼ˆå’Œæ¨¡æ¿äº’æ–¥ï¼‰
    +String address       // å‘é€åœ°å€
    +String channelType   // é€šé“ç±»å‹
    +long channelId       // ä½¿ç”¨çš„é€šé“ID
    +int priority         // æ¶ˆæ¯ä¼˜å…ˆçº§(0-4)
    +bool requireReceipt  // æ˜¯å¦éœ€è¦å›æ‰§
    +String status        // æ¶ˆæ¯çŠ¶æ€(created/sending/sent/delivered/read/failed/recalled)
    +String expireTime    // è¿‡æœŸæ—¶é—´
    +String createdAt     // åˆ›å»ºæ—¶é—´
    +String updatedAt     // æ›´æ–°æ—¶é—´
    +String recallTime    // æ’¤å›æ—¶é—´
    +String receiptTime   // å›æ‰§æ—¶é—´
  }
```

### çŸ­ä¿¡æœåŠ¡

çŸ­ä¿¡æˆ–è¯­éŸ³ç”µè¯

Short Messaging Service åè®®è§„å®šå•æ¡çŸ­ä¿¡å†…å®¹æœ€å¤§é•¿åº¦ **140 byte** ï¼Œä½¿ç”¨ GSM 7 ä½ç¼–ç ä¸€ä¸ªæ±‰å­—å  2 byteï¼Œä¹Ÿå°±æ˜¯æœ€å¤š 70 ä¸ªæ±‰å­—ã€‚

ç”µè¯å·ç æ²¡æœ‰è¯†åˆ«æ€§ï¼Œä¸ºäº†è¡¨æ˜å‘é€è€…èº«ä»½çŸ­ä¿¡å¼€å¤´å¿…é¡»ä½¿ç”¨ **ã€ç­¾åã€‘** è¡¨æ˜èº«ä»½ã€‚

ç­¾åï¼ˆSign)

ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è¯†åˆ«æ¶ˆæ¯æ¥æºï¼Œçº¯æ–‡å­—å†…å®¹çš„æ¶ˆæ¯éƒ½ä¼šæœ‰ç­¾åï¼ˆSignï¼‰ã€‚æŒ‰æä¾›å•†ç®¡ç†

ä»¥ä¸‹æ˜¯æœ€ç®€é€šç”¨è¯·æ±‚å‚æ•°å®ä¾‹ï¼š

```json
{
  "template-code": "captch",
  "params": {
    "code": "F12sf12"
  },
  "destination": [
    {
      "language": "zh-CN",
      "phone-number": "+86 213321321"
    },
    {
      "language": "zh-CN",
      "phone-number": "+86 213321322"
    },
    {
      "language": "en-US",
      "phone-number": "+1 613321324"
    }
  ]
}
```

### ç”µå­é‚®ä»¶

ç”µå­é‚®ä»¶ï¼Œé€šå¸¸éœ€è¦ä¸»é¢˜å’Œé™„ä»¶ï¼Œå†…å®¹æ ¼å¼å¤šä¸º HTML å†…å®¹ï¼Œé™¤æ­¤ä¹‹å¤–é‚®ä»¶æ²¡æœ‰å…¶ä»–é™åˆ¶ã€‚

```json
{
  "template-code": "captch",
  "params": {
    "code": "F12sf12"
  },
  "destination": [
    {
      "language": "zh-CN",
      "email": "tom@email.com"
    },
    {
      "language": "zh-CN",
      "email": "jerry@email.com"
    },
    {
      "language": "en-US",
      "email": "bark@email.com"
    }
  ]
}
```

### å³æ—¶é€šè®¯

å³æ—¶é€šè®¯æ²¡æœ‰ç»Ÿä¸€çš„åè®®ï¼Œåªèƒ½é’ˆå¯¹å„å®¶å¹³å°å•ç‹¬å¯¹æ¥ã€‚

æœ‰çš„å¹³å°æ˜¯æä¾›ä¸€ä¸ªå«åš bot çš„å­è´¦å·ç”¨äºè‡ªåŠ¨å‘å¸ƒæ¶ˆæ¯ï¼Œbot çš„ä½œç”¨èŒƒå›´ä¸€èˆ¬åˆ†ä¸ºå…¨å¹³å°é€šç”¨æˆ–è€…ä¼šè¯ä¸“ç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè‡ªå®šä¹‰åè®®ä½œä¸­é—´åè®®ç”¨æ¥å¯¹æ¥åˆ°ä¸åŒæä¾›å•†çš„ç§æœ‰åè®®ã€‚

```json
{
  "template-code": "warring",
  "params": {
    "target": "email"
  },
  "destination": {
    "zh-CN": ["A-Alert-Chat", "B-Alert-Chat"],
    "en-US": ["C-Alert-Chat"]
  }
}
```

ä»¥ä¸‹æ˜¯åœ°å€è½¬å‘é…ç½®ä¾‹å­ï¼š

```json
{
  "A-Alert-Chat": [
    {
      "platform": "Slack",
      "chat": "CFD7678SG"
    },
    {
      "platform": "DingDing",
      "accessToken": "fkjsagfkash",
      "secureKey": "sadfhipghgoi"
    }
  ],
  "B-Alert-Chat": {
    "platform": "DingDing",
    "accessToken": "fkjsagfkash",
    "secureKey": "sadfhipghgoi"
  }
}
```

### æ¨é€æœåŠ¡

åº”ç”¨ï¼ˆAPPï¼‰ä¸€èˆ¬åˆ†ä¸ºæ¡Œé¢ç«¯ / ç§»åŠ¨ç«¯ / Web ç«¯ï¼Œæ¨é€ï¼ˆPushï¼‰ä¸€èˆ¬åˆ†ä¸ºç³»ç»Ÿæ¨é€å’Œåº”ç”¨æ¨é€ï¼Œæ¯ä¸ªå¹³å°éƒ½æœ‰å„è‡ªå¹³å°çº§çš„æ¨é€æœåŠ¡ï¼Œå¦‚ä¸‹ï¼š

| Platform    | Platform Notification Service                                                                                                                              |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Windows     | [WNS](https://learn.microsoft.com/zh-cn/windows/apps/design/shell/tiles-and-notifications/windows-push-notification-services--wns--overview)               |
| macOS / iOS | [APNs](https://developer.apple.com/notifications/)                                                                                                         |
| Android     | [GCM](https://firebase.google.com/docs/cloud-messaging)                                                                                                    |
| Browser     | [Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API) / [Web Push Protocol](https://web.dev/articles/push-notifications-web-push-protocol) |

[Push](#Push) åªèƒ½é€šçŸ¥ APP å·²æœ‰åŠŸèƒ½çš„ä¿¡æ¯ï¼Œ[SMS](#SMS) / [EMAIL](#Email) / [IM](#IM) é™¤äº†å¯ä»¥é€šçŸ¥ APP å†…çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥é€šçŸ¥å…¶ä»–ä¿¡æ¯ï¼Œæ­¤å¤–è¿˜å¯ä»¥ä½œä¸ºç”¨æˆ·èº«ä»½çš„å‡­è¯ã€‚

#### ä¸ªæ¨

```js
{
  "request_id": "xxx", // è¯·æ±‚æ ‡è¯†ï¼Œé‡å¤å°†å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±
  "settings": {
    "ttl": 7200000 // æ¶ˆæ¯ç¦»çº¿æ—¶é—´è®¾ç½®ï¼Œå•ä½æ¯«ç§’
  },
  "audience": { // æ¶ˆæ¯æ¥æ”¶æ–¹
    "cid": [
      "xxx"
    ]
  },
  "push_message": {
    "notification": {
      "title": "è¯·å¡«å†™é€šçŸ¥æ ‡é¢˜",
      "body": "è¯·å¡«å†™é€šçŸ¥å†…å®¹",
      "click_type": "url",
      "url": "https//:xxx"
    }
  }
}
```

æ¨é€ notification é€šçŸ¥è¡Œä¸ºå’Œæ¨¡æ¿é…ç½®åœ¨ä¸€èµ·ã€‚

```json
{
  "template-code": "change",
  "params": {
    "target": "something"
  },
  "destination": {
    "zh-CN": ["device-id-a", "device-id-b"],
    "en-US": ["device-id-c"]
  }
}
```

å…·ä½“çš„é€šçŸ¥çš„å“é“ƒå½¢å¼ç”±æ¨¡æ¿ç®¡ç†ã€‚

## åˆå§‹å®ç°ä¸åˆ†æ

æ¶ˆæ¯å‘é€å¤„ç†æµç¨‹

- è°ƒç”¨æ–¹ä½¿ç”¨ feign è°ƒç”¨ notifier-gateway ï¼Œ gateway æŠŠæ¶ˆæ¯å†™å…¥ kafka çš„ im-topic\sms-topic\email-topic\push-topicã€‚æ¯ä¸ª topic æ˜¯ 8 ä¸ªåˆ†åŒºã€‚
- sender æœåŠ¡ä» kafka ä¸­ç›‘å¬æ¶ˆæ¯ï¼Œsender æ˜¯ç”¨å•æ¡æ¨¡å¼æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶ä¸”æ˜¯æ‰‹åŠ¨ç¡®è®¤ã€‚æ¯ä¸€ä¸ª topic å°±ä¸€ä¸ª spirng çš„ kafkalistener æ–¹æ³•
- kafalistener æ‹‰å–åˆ°æ¶ˆæ¯åï¼Œå…ˆæŠŠå‘é€ä»»åŠ¡å†™å…¥ mysql ä»¥é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼Œç„¶åå°†å‘é€æ¶ˆæ¯çš„ä»»åŠ¡æ”¾å…¥ im\sms\email\push å¯¹åº”çš„ senderexecutor ä¸­ï¼Œå†™å…¥ mysql åå‘ kafka ç¡®è®¤æˆåŠŸ
- æ¯ä¸€ä¸ª senderexecutor ä¸­éƒ½åŒ…å«ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä»»åŠ¡å°†è¢«æ”¾å…¥çº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œ
- çº¿ç¨‹æ± ä¸­å°†æ‰§è¡Œï¼Œæ‰¾åˆ°æ¨¡æ¿ï¼Œå¡«å……å‚æ•°ï¼Œæ‰¾åˆ°å‘é€åœ°å€åŒ¹é…çš„æœåŠ¡æä¾›å•†ï¼Œè°ƒç”¨æä¾›å•† apiï¼Œæ‹¿åˆ°æä¾›å•†è¿”å›ç»“æœï¼Œå†™å…¥ mysql å­˜å‚¨ä»»åŠ¡æ¶ˆæ¯ç»“æœæ ä¸­
- senderexecutor ä¸­çš„ä»»åŠ¡ï¼Œä½¿ç”¨ apache httpclient å‘æä¾›å•†å‘é€ post è¯·æ±‚ï¼Œå¹¶åŒæ­¥ç­‰å¾…å“åº”ç»“æœï¼Œå¹¶æŠŠç»“æœå†™å…¥ mysql çš„æ—¥å¿—ä¸­ã€‚
- å¦‚æœå‘é€å¤±è´¥ï¼Œé¦–å…ˆå°†æ¶ˆæ¯å†™å…¥ mysql å‘é€ä»»åŠ¡ä¸­ï¼Œç„¶åé‡æ–°æ”¾å…¥ kafka é˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æœ‰å”¯ä¸€ä»»åŠ¡å·ï¼Œæ¯ä¸ªä»»åŠ¡æœ€å¤šé‡è¯• 3 æ¬¡

**å…³é”®æ€§èƒ½èŠ‚ç‚¹ï¼š**

- **åŒæ­¥ MySQL å†™å…¥**ï¼šæ¯ä¸ªä»»åŠ¡æ¶‰åŠ 2 æ¬¡åŒæ­¥æ•°æ®åº“æ“ä½œ
- **çº¿ç¨‹æ± æ‰§è¡Œ**ï¼šçº¿ç¨‹æ•°é‡ç›´æ¥å½±å“å¹¶å‘å¤„ç†èƒ½åŠ›
- **ï¸ Mock API è°ƒç”¨**ï¼š100msÂ±50ms çš„æ¨¡æ‹Ÿè€—æ—¶
- **å•æ¡ Kafka æ‹‰å–**ï¼šé€æ¡å¤„ç†æ¶ˆæ¯ï¼Œæ— æ‰¹é‡ä¼˜åŒ–

### 80 TPS åˆ†æ

åœ¨ mock æä¾›å•†è€—æ—¶ 100ms å·¦å³æ³¢åŠ¨ 50msï¼Œä¸çœŸå®å‘é€ï¼Œä½¿ç”¨è¿œç¨‹ kafkaï¼Œä½¿ç”¨è¿œç¨‹ mysqlï¼Œçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ gateway å‹æµ‹ sms å‘é€çš„ tpsï¼Œåœ¨ i5 çš„å¼€å‘ç¬”è®°æœ¬ä¸Šæœ€å¤§åªèƒ½åˆ° 80tps

**ç†è®ºè®¡ç®— vs å®é™…ç»“æœ**

**å½“å‰é…ç½®åˆ†æï¼š**

```
å®é™…çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•° = 8
ç†è®ºTPS = 8çº¿ç¨‹ Ã· æ€»å¤„ç†æ—¶é—´

åŸºäºå‹æµ‹ç»“æœ80 TPSåæ¨æ€»å¤„ç†æ—¶é—´ï¼š
80 TPS = 8çº¿ç¨‹ Ã· æ€»å¤„ç†æ—¶é—´
æ€»å¤„ç†æ—¶é—´ = 8 Ã· 80 = 0.1ç§’ = 100ms

é‡æ–°åˆ†æå„ç¯èŠ‚è€—æ—¶ï¼š
- Kafkaå•æ¡æ‹‰å–: ~10ms (è¿œç¨‹ç½‘ç»œï¼Œä¼˜åŒ–å)
- MySQLå†™å…¥å‘é€ä»»åŠ¡: ~5ms (è¿œç¨‹æ•°æ®åº“)
- çº¿ç¨‹æ± ä»»åŠ¡æäº¤: ~2ms
- ä¸šåŠ¡é€»è¾‘å¤„ç†: ~5ms
- Mock APIè°ƒç”¨: 100msÂ±50ms (å¹³å‡75ms)
- MySQLå†™å…¥ç»“æœ: ~5ms (è¿œç¨‹æ•°æ®åº“)
- Kafkaç¡®è®¤: ~3ms

æ€»è®¡: 10+5+2+5+75+5+3 = 105ms â‰ˆ 100ms
```

**å®é™… TPS è®¡ç®—ï¼š**

```
ç†è®ºTPS = 8çº¿ç¨‹ Ã· 0.1ç§’ = 80 TPS
```

è¿™å®Œç¾è§£é‡Šäº†ä¸ºä»€ä¹ˆå‹æµ‹ç»“æœæ­£å¥½æ˜¯ 80 TPSï¼

| ç“¶é¢ˆç±»å‹       | å…·ä½“é—®é¢˜               | è€—æ—¶å æ¯” | å½±å“ç¨‹åº¦  |
| ---------- | ------------------ | ---- | ----- |
| **çº¿ç¨‹é™åˆ¶**   | ä»… 8 ä¸ªçº¿ç¨‹å¹¶å‘å¤„ç†        | 60%  | â­â­â­â­â­ |
| **æ•°æ®åº“ IO** | 2 æ¬¡ MySQL å†™å…¥(10ms) | 25%  | â­â­â­â­  |
| **ç½‘ç»œå»¶è¿Ÿ**   | Kafka æ“ä½œ(13ms)     | 15%  | â­â­â­   |

### TPS ä¼˜åŒ–æ–¹æ¡ˆåˆ†æ

#### è°ƒå¤§çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°

**ä¼˜åŒ–åŸç†ï¼š**
æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ›´å……åˆ†åˆ©ç”¨ CPU å’Œç½‘ç»œèµ„æº

**æ•ˆæœåˆ†æï¼š**

```
çº¿ç¨‹æ•°ä»8 â†’ 16: TPS = 16 Ã· 0.1 = 160 TPS (+100%)
çº¿ç¨‹æ•°ä»8 â†’ 32: TPS = 32 Ã· 0.1 = 320 TPS (+300%)
çº¿ç¨‹æ•°ä»8 â†’ 64: TPS = 64 Ã· 0.1 = 640 TPS (+700%)
çº¿ç¨‹æ•°ä»8 â†’ 128: TPS = 128 Ã· 0.1 = 1280 TPS (+1500%)
```

**æ³¨æ„äº‹é¡¹ï¼š**

- **æ•°æ®åº“è¿æ¥æ± é™åˆ¶**ï¼šéœ€è¦ç›¸åº”è°ƒæ•´ MySQL è¿æ¥æ± å¤§å°
- **å†…å­˜æ¶ˆè€—**ï¼šæ¯ä¸ªçº¿ç¨‹çº¦å ç”¨ 1-2MB æ ˆç©ºé—´
- **ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼šçº¿ç¨‹è¿‡å¤šä¼šå¢åŠ  CPU è°ƒåº¦å¼€é”€

**æ¨èé…ç½®ï¼š**

```java
ThreadPoolExecutor smsExecutor = new ThreadPoolExecutor(
    16, 32, // æ ¸å¿ƒ16ï¼Œæœ€å¤§32çº¿ç¨‹ (ç›¸æ¯”å½“å‰8çº¿ç¨‹æå‡4å€)
    60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(2000),
    new ThreadFactoryBuilder().setNameFormat("sms-sender-%d").build()
);
```

**ç°ä»£çº¿ç¨‹æ•°é…ç½®æŒ‡å—ï¼š**

**Platform çº¿ç¨‹ï¼ˆä¼ ç»Ÿçº¿ç¨‹ï¼‰èƒ½åŠ›æå‡ï¼š**

- **å†å²å±€é™**ï¼šæ—©æœŸ Javaï¼ˆ~2016 å¹´ï¼‰æ¨è 200-400 çº¿ç¨‹ï¼Œä¸»è¦å—é™äºæ¯çº¿ç¨‹ 1MB æ ˆç©ºé—´å’Œå†…å­˜æˆæœ¬
- **ç°ä»£èƒ½åŠ›**ï¼šå½“å‰ç¡¬ä»¶ä¸‹ï¼Œ500-2000 çº¿ç¨‹æ˜¯å®‰å…¨èŒƒå›´ï¼Œé«˜ç«¯æœåŠ¡å™¨å¯æ”¯æŒ 4000-8000 çº¿ç¨‹
- **ç½‘ç»œ IO åœºæ™¯**ï¼šCPU æ ¸å¿ƒæ•° Ã— 20-50 çš„çº¿ç¨‹æ•°é€šå¸¸æ˜¯åˆç†çš„
- **å®é™…æµ‹è¯•**ï¼š8GB å†…å­˜æœåŠ¡å™¨å¯ç¨³å®šè¿è¡Œ~2000 ä¸ª Platform çº¿ç¨‹

**Virtual çº¿ç¨‹ï¼ˆJava 21+ï¼‰é©å‘½æ€§æå‡ï¼š**

```java
// Java 21+ Virtualçº¿ç¨‹é…ç½®ï¼ˆæ¨èï¼‰
ExecutorService virtualExecutor = Executors.newVirtualThreadPerTaskExecutor();
// æ— éœ€é…ç½®çº¿ç¨‹æ•°é™åˆ¶ï¼Œå¯è½»æ¾å¤„ç†ç™¾ä¸‡çº§å¹¶å‘ï¼

// ä¼ ç»Ÿé…ç½®å¯¹æ¯”
ThreadPoolExecutor platformExecutor = new ThreadPoolExecutor(
    32, 1000, // ç°ä»£Platformçº¿ç¨‹å¯ä»¥è®¾ç½®åˆ°1000+
    60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(5000)
);
```

**Virtual çº¿ç¨‹ä¼˜åŠ¿ï¼š**

- **å†…å­˜å ç”¨**ï¼šæ¯ä¸ª Virtual çº¿ç¨‹ä»…éœ€å‡  KB å †å†…å­˜ï¼ˆvs Platform çº¿ç¨‹ 1MB æ ˆç©ºé—´ï¼‰
- **åˆ›å»ºæˆæœ¬**ï¼šæä½ï¼Œå¯ä»¥ per-request åˆ›å»º
- **å¹¶å‘èƒ½åŠ›**ï¼šç†è®ºä¸Šå¯è¾¾ç™¾ä¸‡çº§ï¼Œå®Œç¾é€‚é…ç½‘ç»œ IO å¯†é›†å‹ä»»åŠ¡
- **è°ƒåº¦æ•ˆç‡**ï¼šJVM å†…éƒ¨è°ƒåº¦ï¼Œæ¯” OS çº¿ç¨‹è°ƒåº¦æ›´é«˜æ•ˆ

**è¿ç§»å»ºè®®ï¼š**

1. **Java 8-20 é¡¹ç›®**ï¼šPlatform çº¿ç¨‹æ•°å¯ä»å½“å‰ 8 çº¿ç¨‹æå‡åˆ° 32-128 çº¿ç¨‹
2. **Java 21+é¡¹ç›®**ï¼šä¼˜å…ˆé‡‡ç”¨ Virtual çº¿ç¨‹ï¼Œç‰¹åˆ«é€‚åˆé€šçŸ¥ä¸­å¿ƒè¿™ç±»ç½‘ç»œ IO åœºæ™¯
3. **æ¸è¿›å¼å‡çº§**ï¼šå…ˆæå‡ Platform çº¿ç¨‹æ•°éªŒè¯æ•ˆæœï¼Œå†è€ƒè™‘å‡çº§åˆ° Virtual çº¿ç¨‹

#### å¼‚æ­¥å†™ MySQL æ—¥å¿—

**ä¼˜åŒ–åŸç†ï¼š**
å°†åŒæ­¥æ•°æ®åº“å†™å…¥æ”¹ä¸ºå¼‚æ­¥ï¼Œå‡å°‘ä¸»æµç¨‹é˜»å¡æ—¶é—´

**å®ç°æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ Aï¼šå¼‚æ­¥å†™å…¥çº¿ç¨‹æ± **

```java
@Async("mysqlWriteExecutor")
public CompletableFuture<Void> asyncWriteTask(SendTask task) {
    // å¼‚æ­¥å†™å…¥å‘é€ä»»åŠ¡
    taskRepository.save(task);
    return CompletableFuture.completedFuture(null);
}

@Async("mysqlWriteExecutor")
public CompletableFuture<Void> asyncWriteResult(SendResult result) {
    // å¼‚æ­¥å†™å…¥å‘é€ç»“æœ
    resultRepository.save(result);
    return CompletableFuture.completedFuture(null);
}
```

**æ–¹æ¡ˆ Bï¼šæœ¬åœ°ç¼“å­˜ + æ‰¹é‡åˆ·ç›˜**

```java
// æœ¬åœ°å†…å­˜é˜Ÿåˆ—æš‚å­˜
private final BlockingQueue<SendTask> taskQueue = new LinkedBlockingQueue<>(5000);
private final BlockingQueue<SendResult> resultQueue = new LinkedBlockingQueue<>(5000);

// å®šæ—¶æ‰¹é‡å†™å…¥æ•°æ®åº“
@Scheduled(fixedDelay = 100) // æ¯100msæ‰¹é‡å†™å…¥ä¸€æ¬¡
public void batchWriteTasks() {
    List<SendTask> tasks = new ArrayList<>();
    taskQueue.drainTo(tasks, 500); // æ¯æ¬¡æœ€å¤š500æ¡
    if (!tasks.isEmpty()) {
        taskRepository.saveAll(tasks);
    }
}
```

### ç½‘ç»œè¯·æ±‚éƒ¨åˆ†

åŸºäºé€šçŸ¥ä¸­å¿ƒçš„åˆå§‹å®ç°åˆ†æï¼Œæˆ‘æ¥è¯¦ç»†å›ç­”æ‚¨å…³äºä½¿ç”¨ OkHttp å¼‚æ­¥æ›¿æ¢ Apache HttpClient åŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š

**ç°æœ‰ç“¶é¢ˆï¼š**

- Apache HttpClient åŒæ­¥è°ƒç”¨ï¼šæ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹ç›´åˆ°å“åº”è¿”å›
- çº¿ç¨‹æ± é™åˆ¶ï¼šå½“å‰ 8 ä¸ªçº¿ç¨‹ï¼Œæˆä¸ºä¸»è¦æ€§èƒ½ç“¶é¢ˆ
- æ€»å¤„ç†æ—¶é—´ï¼š100msï¼ˆå…¶ä¸­ API è°ƒç”¨ 75ms å å¤§å¤´ï¼‰

#### æ–¹æ¡ˆ 1ï¼šä¿ç•™çº¿ç¨‹æ±  + OkHttp å¼‚æ­¥

**å®ç°æ–¹å¼ï¼š**

```java
// SenderExecutorä¸­ä½¿ç”¨OkHttpå¼‚æ­¥
public CompletableFuture<Void> sendMessage(SendTask task) {
    return CompletableFuture.supplyAsync(() -> {
        // 1. æ¨¡æ¿å¤„ç†ã€å‚æ•°å¡«å……ï¼ˆ5msï¼‰
        // 2. æä¾›å•†é€‰æ‹©ï¼ˆ2msï¼‰
        return buildRequest(task);
    }, threadPool).thenCompose(request -> {
        // 3. OkHttpå¼‚æ­¥è°ƒç”¨
        return sendHttpRequestAsync(request);
    }).thenCompose(response -> {
        // 4. å¼‚æ­¥å†™å…¥MySQLç»“æœ
        return writeResultAsync(response);
    });
}
```

**TPS æå‡æ•ˆæœï¼š**

- **å½“å‰**ï¼š80 TPSï¼ˆ8 çº¿ç¨‹ Ã— 10 æ¬¡/ç§’ï¼‰
- **ä¼˜åŒ–å**ï¼š400-800 TPSï¼ˆ8 çº¿ç¨‹ Ã— 50-100 æ¬¡/ç§’ï¼‰
- **æå‡å¹…åº¦**ï¼š5-10 å€

**åŸå› åˆ†æï¼š**

- çº¿ç¨‹ä¸å†é˜»å¡ç­‰å¾… HTTP å“åº”
- æ¯ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†æ›´å¤šä»»åŠ¡
- HTTP è°ƒç”¨å˜ä¸ºå¼‚æ­¥ï¼Œçº¿ç¨‹åˆ©ç”¨ç‡å¤§å¹…æå‡

#### æ–¹æ¡ˆ 2ï¼šå»æ‰çº¿ç¨‹æ±  + OkHttp å¼‚æ­¥

**å®ç°æ–¹å¼ï¼š**

```java
// ç›´æ¥åœ¨KafkaListenerä¸­å¼‚æ­¥å¤„ç†
@KafkaListener(topics = "sms-topic")
public void handleMessage(SendTask task) {
    // ç›´æ¥å¼‚æ­¥å¤„ç†ï¼Œæ— éœ€çº¿ç¨‹æ± 
    processMessageAsync(task)
        .thenCompose(this::sendHttpRequestAsync)
        .thenCompose(this::writeResultAsync)
        .whenComplete((result, ex) -> {
            // ç¡®è®¤Kafkaæ¶ˆæ¯
            kafkaTemplate.ack();
        });
}
```

**TPS æå‡æ•ˆæœï¼š**

- **ç†è®ºä¸Šé™**ï¼šå‡ ä¹æ— é™åˆ¶ï¼ˆå—é™äºç½‘ç»œå’Œæ•°æ®åº“ï¼‰
- **å®é™…é¢„æœŸ**ï¼š2000-5000 TPS
- **æå‡å¹…åº¦**ï¼š25-60 å€

**ä¼˜åŠ¿ï¼š**

- å®Œå…¨æ¶ˆé™¤çº¿ç¨‹æ± ç“¶é¢ˆ
- å†…å­˜å ç”¨å¤§å¹…é™ä½
- ç³»ç»Ÿæ¶æ„æ›´ç®€æ´

| æ–¹æ¡ˆ   | çº¿ç¨‹æ±   | TPS æå‡  | å†…å­˜å ç”¨ | å®ç°å¤æ‚åº¦ | æ¨èæŒ‡æ•°  |
| ---- | ---- | ------- | ---- | ----- | ----- |
| å½“å‰æ–¹æ¡ˆ | 8 çº¿ç¨‹ | åŸºå‡† 80   | é«˜    | ä½     | â­â­    |
| æ–¹æ¡ˆ 1 | ä¿ç•™   | 5-10 å€  | ä¸­ç­‰   | ä¸­ç­‰    | â­â­â­â­  |
| æ–¹æ¡ˆ 2 | å»æ‰   | 25-60 å€ | ä½    | é«˜     | â­â­â­â­â­ |

#### OkHttp å¼‚æ­¥é…ç½®

```java
OkHttpClient client = new OkHttpClient.Builder()
    .connectionPool(new ConnectionPool(200, 5, TimeUnit.MINUTES))
    .connectTimeout(5, TimeUnit.SECONDS)
    .readTimeout(10, TimeUnit.SECONDS)
    .build();

// å¼‚æ­¥å‘é€
public CompletableFuture<String> sendAsync(Request request) {
    CompletableFuture<String> future = new CompletableFuture<>();

    client.newCall(request).enqueue(new Callback() {
        @Override
        public void onResponse(Call call, Response response) {
            future.complete(response.body().string());
        }

        @Override
        public void onFailure(Call call, IOException e) {
            future.completeExceptionally(e);
        }
    });

    return future;
}
```
